name: Quality & Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at midnight UTC
    - cron: '0 0 * * 0'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================
  # CODE QUALITY
  # ============================================
  
  format:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --check

  clippy:
    name: Clippy Lints
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config libxdo-dev
      - run: cargo clippy -- -D warnings

  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config libxdo-dev
      - run: cargo test --all-features

  # ============================================
  # SECURITY
  # ============================================

  cargo-deny:
    name: Dependency Policy & Advisories
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install cargo-deny --locked
      - run: cargo deny check

  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  trivy:
    name: Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true

  semgrep:
    name: Static Analysis
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4
      - run: semgrep scan --config auto --error --exclude-rule "javascript.lang.security.detect-insecure-websocket.detect-insecure-websocket"

  # ============================================
  # PERFORMANCE
  # ============================================

  binary-size:
    name: Binary Size Check
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build release binary
        run: cargo build --release --target x86_64-pc-windows-msvc

      - name: Check binary size
        shell: pwsh
        run: |
          $binary = "target/x86_64-pc-windows-msvc/release/pc-bridge.exe"
          $size = (Get-Item $binary).Length
          $sizeMB = [math]::Round($size / 1MB, 2)
          Write-Host "Binary size: $sizeMB MB ($size bytes)"
          
          # Warn if binary exceeds 15MB (arbitrary threshold)
          if ($size -gt 15MB) {
            Write-Host "::warning::Binary size ($sizeMB MB) exceeds 15MB threshold"
          }
          
          # Fail if binary exceeds 25MB
          if ($size -gt 25MB) {
            Write-Host "::error::Binary size ($sizeMB MB) exceeds 25MB limit"
            exit 1
          }
